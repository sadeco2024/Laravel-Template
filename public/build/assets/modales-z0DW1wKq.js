document.querySelectorAll(".sd-modalForm").forEach(r=>{const s=document.querySelector(".modal-body"),i=document.querySelector(".modal-title");r.addEventListener("show.bs.modal",function(t){const c=t.relatedTarget,p=c.getAttribute("data-url"),y=c.getAttribute("data-title"),E=c.getAttribute("data-param");i.textContent=y,s.innerHTML="",fetch(p).then(h=>h.text()).then(h=>{s.innerHTML=h;const d=s.querySelector("form"),b=document.createElement("input");if(b.type="hidden",b.name="param",b.value=E,!d)throw new Error("Error: Falta el <form> en la vista");d.appendChild(b),d.addEventListener("submit",function(g){g.preventDefault();const o=document.querySelector(".modal-footer").querySelector('[type="submit"]');o.data={btnhtml:o.innerHTML},o.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...',o.disabled=!0,fetch(d.action,{method:d.method,body:new FormData(d)}).then(e=>e.json()).then(e=>{if(console.log(e),L(),e.table&&typeof e.table=="object"){console.log(e.table,typeof e.table);for(let n in e.table){let u=document.getElementById(n);console.log("render",u);let m=u.getElementsByTagName("tbody")[0];if(m.innerHTML="",Array.isArray(e.table[n]))e.table[n].forEach(l=>{let a=m.insertRow();console.log("row:",a);for(let f in l){let w=a.insertCell();w.innerHTML=l[f]}});else if(typeof e.table[n]=="object"){console.log(Object.values(e.table[n])),e.table[n]=Object.values(e.table[n]);let l=m.insertRow();e.table[n].forEach(a=>{console.log("row:",l);let f=l.insertCell();f.innerHTML=a})}else console.log("type:",typeof e.table)}}if(e.alert){try{Swal.fire({position:"center",icon:e.status>0?"error":"success",title:e.msg??(e.status?"Operación NO realizada.":"Operación realizada con éxito."),showConfirmButton:!1,timer:1500})}catch{throw new Error("Error: Falta librería SweetAlerts2")}o.innerHTML=o.data.btnhtml,o.disabled=!1}if(e.redirect)e.alert||(window.location.href=e.redirect);else if(o.innerHTML=o.data.btnhtml,o.disabled=!1,e.errors){const n=e.errors;for(const u in n){const m=n[u][0],l=document.createElement("small");l.classList.add("text-sm","text-danger","text-muted","invalid"),l.textContent=m;const a=document.getElementsByName(u)[0];a.classList.add("is-invalid"),a.closest(".input-group").insertAdjacentElement("afterend",l)}}}).catch(e=>{o.innerHTML=o.data.btnhtml,o.disabled=!1,console.error("Error:",e)})})})})});function L(){document.querySelectorAll("small.invalid").forEach(s=>{s.remove()}),document.querySelectorAll("form .is-invalid").forEach(s=>{s.classList.remove("is-invalid")})}document.querySelectorAll(".save").forEach(r=>{r.addEventListener("click",s=>{s.preventDefault(),r.data={btnhtml:r.innerHTML},r.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...',r.disabled=!0;const i=r.closest("form");fetch(i.action,{method:i.method,body:new FormData(i)}).then(t=>t.json()).then(t=>{r.innerHTML=r.data.btnhtml,r.disabled=!1;try{console.log(t.status),Swal.fire({position:"center",icon:t.status>0?"error":"success",title:t.msg!==""?t.msg:t.status>0?"Operación NO realizada.":"Operación realizada con éxito.",showConfirmButton:!1,timer:1500})}catch(c){throw new Error("Mensaje: "+c.message)}}).catch(t=>{r.innerHTML=r.data.btnhtml,r.disabled=!1,console.error("Error:",t)})})});document.querySelectorAll(".save-link").forEach(r=>{r.addEventListener("click",s=>{s.preventDefault(),console.log(r);const i=r.getAttribute("data-link");r.data={btnhtml:r.innerHTML},r.innerHTML='<span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>',r.disabled=!0,fetch(i).then(t=>t.json()).then(t=>{try{Swal.fire({position:"center",icon:t.status>0?"error":"success",title:t.msg??(t.status?"Operación NO realizada.":"Operación realizada con éxito."),showConfirmButton:!1,timer:1500})}catch{throw new Error("Error: Falta librería SweetAlerts2")}r.innerHTML=r.data.btnhtml,r.disabled=!1}).catch(t=>{console.error("Error:",t)})})});
